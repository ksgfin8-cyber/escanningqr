<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Validaci√≥n - Extensi√≥n QR InHouse</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a2e; color: #eee; }
        .test { margin: 10px 0; padding: 10px; border-radius: 8px; }
        .pass { background: #0f5132; }
        .fail { background: #842029; }
        .section { margin-top: 30px; border-top: 2px solid #444; padding-top: 20px; }
        h2 { color: #ffc107; }
        h3 { color: #17a2b8; }
        pre { background: #2d2d44; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
<h1>üß™ Validaci√≥n - Extensi√≥n QR InHouse</h1>
<div id="results"></div>

<script src="menu.js"></script>
<script src="sistema.js"></script>
<script>
const results = document.getElementById('results');
let passCount = 0;
let failCount = 0;

function log(message, pass = true) {
    const div = document.createElement('div');
    div.className = `test ${pass ? 'pass' : 'fail'}`;
    div.innerHTML = `${pass ? '‚úÖ' : '‚ùå'} ${message}`;
    results.appendChild(div);
    if (pass) passCount++; else failCount++;
}

function section(title) {
    const div = document.createElement('div');
    div.className = 'section';
    div.innerHTML = `<h2>${title}</h2>`;
    results.appendChild(div);
}

function subsection(title) {
    const h3 = document.createElement('h3');
    h3.textContent = title;
    results.appendChild(h3);
}

function showCode(label, code) {
    const pre = document.createElement('pre');
    pre.textContent = `${label}: ${JSON.stringify(code, null, 2)}`;
    results.appendChild(pre);
}

// ============================================
// 1. VALIDACI√ìN DE DETERMINISMO
// ============================================
section('1Ô∏è‚É£ Validaci√≥n de Determinismo');

// Test: Contexto congelado
subsection('Contexto congelado');
const contextoNormal = Object.freeze({ modo: 'normal' });
const contextoInhouse = Object.freeze({ modo: 'inhouse' });

try {
    contextoNormal.modo = 'changed';
    log('Contexto normal es mutable (FALLO)', false);
} catch (e) {
    log('Contexto normal est√° correctamente congelado (Object.freeze)');
}

try {
    contextoInhouse.modo = 'changed';
    log('Contexto inhouse es mutable (FALLO)', false);
} catch (e) {
    log('Contexto inhouse est√° correctamente congelado (Object.freeze)');
}

// Test: Misma entrada ‚Üí mismo resultado
subsection('Determinismo: misma entrada ‚Üí mismo resultado');
const pedidoTest = { bases: [{ id: 'A', cantidad: 1 }], extras: [] };
const tiempoMock = Object.freeze({
    hora: 10,
    minutos: 30,
    minutosTotales: 630,
    diaSemana: 1, // Lunes
    franja: 'TEMPRANO',
    puntosBase: 3,
    despachoMinutos: 720,
    esFinDeSemana: false,
    timestamp: Date.now(),
    fechaLegible: '15/01/2026',
    horaLegible: '10:30'
});

const eval1 = Reglas.evaluar(pedidoTest, tiempoMock, contextoNormal);
const eval2 = Reglas.evaluar(pedidoTest, tiempoMock, contextoNormal);
log(`Dos evaluaciones id√©nticas producen mismo resultado: ${JSON.stringify(eval1) === JSON.stringify(eval2)}`);

// ============================================
// 2. VALIDACI√ìN DE REGLAS DE PUNTOS
// ============================================
section('2Ô∏è‚É£ Validaci√≥n de Reglas de Puntos');

// Crear tiempos mock para cada franja
const tiempoTemprano = Object.freeze({
    hora: 8, minutos: 0, minutosTotales: 480, diaSemana: 1,
    franja: 'TEMPRANO', puntosBase: 3, despachoMinutos: 720, esFinDeSemana: false,
    timestamp: Date.now(), fechaLegible: '15/01/2026', horaLegible: '08:00'
});

const tiempoNormal = Object.freeze({
    hora: 11, minutos: 30, minutosTotales: 690, diaSemana: 1,
    franja: 'NORMAL', puntosBase: 1, despachoMinutos: 720, esFinDeSemana: false,
    timestamp: Date.now(), fechaLegible: '15/01/2026', horaLegible: '11:30'
});

const tiempoTardio = Object.freeze({
    hora: 12, minutos: 30, minutosTotales: 750, diaSemana: 1,
    franja: 'TARDIO', puntosBase: 0, despachoMinutos: 780, esFinDeSemana: false,
    timestamp: Date.now(), fechaLegible: '15/01/2026', horaLegible: '12:30'
});

const tiempoCerrado = Object.freeze({
    hora: 20, minutos: 0, minutosTotales: 1200, diaSemana: 1,
    franja: null, puntosBase: 0, despachoMinutos: null, esFinDeSemana: false,
    timestamp: Date.now(), fechaLegible: '15/01/2026', horaLegible: '20:00'
});

// MODO DELIVERY
subsection('Modo Delivery');
const deliveryTemprano = Reglas.evaluar(pedidoTest, tiempoTemprano, { modo: 'normal' });
const deliveryNormal = Reglas.evaluar(pedidoTest, tiempoNormal, { modo: 'normal' });
const deliveryTardio = Reglas.evaluar(pedidoTest, tiempoTardio, { modo: 'normal' });

log(`Delivery TEMPRANO ‚Üí ${deliveryTemprano.puntos} puntos (esperado: 3)`, deliveryTemprano.puntos === 3);
log(`Delivery NORMAL ‚Üí ${deliveryNormal.puntos} puntos (esperado: 1)`, deliveryNormal.puntos === 1);
log(`Delivery TARDIO ‚Üí ${deliveryTardio.puntos} puntos (esperado: 0)`, deliveryTardio.puntos === 0);

// MODO INHOUSE
subsection('Modo InHouse');
const inhouseTemprano = Reglas.evaluar(pedidoTest, tiempoTemprano, { modo: 'inhouse' });
const inhouseNormal = Reglas.evaluar(pedidoTest, tiempoNormal, { modo: 'inhouse' });
const inhouseTardio = Reglas.evaluar(pedidoTest, tiempoTardio, { modo: 'inhouse' });
const inhouseCerrado = Reglas.evaluar(pedidoTest, tiempoCerrado, { modo: 'inhouse' });

log(`InHouse TEMPRANO (mercado abierto) ‚Üí ${inhouseTemprano.puntos} puntos (esperado: 3)`, inhouseTemprano.puntos === 3);
log(`InHouse NORMAL (mercado abierto) ‚Üí ${inhouseNormal.puntos} puntos (esperado: 3)`, inhouseNormal.puntos === 3);
log(`InHouse TARDIO (mercado abierto) ‚Üí ${inhouseTardio.puntos} puntos (esperado: 3)`, inhouseTardio.puntos === 3);
log(`InHouse CERRADO ‚Üí ${inhouseCerrado.puntos} puntos (esperado: 0)`, inhouseCerrado.puntos === 0);

// Verificar que puntosBase no fue mutado
subsection('Inmutabilidad de puntosBase');
log(`tiempoTemprano.puntosBase sigue siendo 3: ${tiempoTemprano.puntosBase === 3}`, tiempoTemprano.puntosBase === 3);
log(`tiempoNormal.puntosBase sigue siendo 1: ${tiempoNormal.puntosBase === 1}`, tiempoNormal.puntosBase === 1);
log(`tiempoTardio.puntosBase sigue siendo 0: ${tiempoTardio.puntosBase === 0}`, tiempoTardio.puntosBase === 0);

// ============================================
// 3. VALIDACI√ìN DE INVARIANTES ARQUITECT√ìNICOS
// ============================================
section('3Ô∏è‚É£ Validaci√≥n de Invariantes Arquitect√≥nicos');

// IG.1: D no conoce modo
subsection('IG.1 ‚Äî D no conoce modo');
const tiempoReal = Tiempo.obtenerEstado();
log(`D.obtenerEstado() no tiene propiedad 'modo': ${!('modo' in tiempoReal)}`, !('modo' in tiempoReal));
log(`D.obtenerEstado() retorna Object.freeze: ${Object.isFrozen(tiempoReal)}`, Object.isFrozen(tiempoReal));

// IE.1: E no altera estadoTiempo
subsection('IE.1 ‚Äî E no altera estadoTiempo');
const tiempoAntes = JSON.stringify(tiempoTemprano);
Reglas.evaluar(pedidoTest, tiempoTemprano, { modo: 'inhouse' });
const tiempoDespues = JSON.stringify(tiempoTemprano);
log(`estadoTiempo no fue alterado por E: ${tiempoAntes === tiempoDespues}`, tiempoAntes === tiempoDespues);

// IF.2: F no toma decisiones
subsection('IF.2 ‚Äî F traduce, no decide');
const evalConDespacho = { ejecutabilidad: 'AHORA', motivo: null, despachoAsignado: '12:00', estadoMercado: 'ABIERTO_TEMPRANO', puntos: 3 };
const evalSinDespacho = { ejecutabilidad: 'AHORA', motivo: null, despachoAsignado: null, estadoMercado: 'ABIERTO_TEMPRANO', puntos: 3 };

const msgDelivery = Traductor.generarMensaje(pedidoTest, evalConDespacho, tiempoTemprano, MENU_DATA, { modo: 'normal' });
const msgInhouse = Traductor.generarMensaje(pedidoTest, evalSinDespacho, tiempoTemprano, MENU_DATA, { modo: 'inhouse' });

log(`F incluye despacho cuando evaluacion.despachoAsignado existe: ${msgDelivery.includes('Despacho estimado')}`, msgDelivery.includes('Despacho estimado'));
log(`F omite despacho cuando evaluacion.despachoAsignado es null: ${!msgInhouse.includes('Despacho estimado')}`, !msgInhouse.includes('Despacho estimado'));

// IG.2: G √∫nico stateful
subsection('IG.2 ‚Äî G √∫nico stateful');
log(`Sistema tiene propiedad 'contexto': ${'contexto' in Sistema}`, 'contexto' in Sistema);
log(`Sistema tiene propiedad 'estado': ${'estado' in Sistema}`, 'estado' in Sistema);
log(`Pedido no tiene estado interno: ${typeof Pedido.estado === 'undefined'}`, typeof Pedido.estado === 'undefined');
log(`Tiempo no tiene estado interno: ${typeof Tiempo.estado === 'undefined'}`, typeof Tiempo.estado === 'undefined');
log(`Reglas no tiene estado interno: ${typeof Reglas.estado === 'undefined'}`, typeof Reglas.estado === 'undefined');
log(`Traductor no tiene estado interno: ${typeof Traductor.estado === 'undefined'}`, typeof Traductor.estado === 'undefined');

// ============================================
// 4. VALIDACI√ìN DE COMPORTAMIENTO VISUAL
// ============================================
section('4Ô∏è‚É£ Validaci√≥n de Comportamiento Visual (Mensaje)');

subsection('Modo InHouse - Etiqueta');
log(`Mensaje InHouse incluye etiqueta 'üè† IN THE HOUSE': ${msgInhouse.includes('üè† IN THE HOUSE')}`, msgInhouse.includes('üè† IN THE HOUSE'));

// Verificar posici√≥n de etiqueta
const lines = msgInhouse.split('\n');
const titleIndex = lines.findIndex(l => l.includes('PEDIDO DE ALMUERZO'));
const tagIndex = lines.findIndex(l => l.includes('IN THE HOUSE'));
log(`Etiqueta aparece inmediatamente despu√©s del t√≠tulo: ${tagIndex === titleIndex + 1}`, tagIndex === titleIndex + 1);

subsection('Modo Normal - Sin etiqueta');
log(`Mensaje Normal NO incluye etiqueta: ${!msgDelivery.includes('IN THE HOUSE')}`, !msgDelivery.includes('IN THE HOUSE'));

subsection('Modo InHouse - Sin despacho');
log(`Mensaje InHouse NO incluye despacho: ${!msgInhouse.includes('Despacho')}`, !msgInhouse.includes('Despacho'));

subsection('Modo Normal - Con despacho');
log(`Mensaje Normal incluye despacho: ${msgDelivery.includes('Despacho')}`, msgDelivery.includes('Despacho'));

// Mostrar mensajes generados
subsection('Mensajes Generados');
showCode('Mensaje Delivery', msgDelivery);
showCode('Mensaje InHouse', msgInhouse);

// ============================================
// 5. VALIDACI√ìN DE DESPACHO
// ============================================
section('5Ô∏è‚É£ Validaci√≥n de DespachoAsignado');

subsection('Modo Delivery - Despacho calculado');
log(`Delivery tiene despachoAsignado: ${deliveryTemprano.despachoAsignado !== null}`, deliveryTemprano.despachoAsignado !== null);
log(`Delivery despachoAsignado = '12:00': ${deliveryTemprano.despachoAsignado === '12:00'}`, deliveryTemprano.despachoAsignado === '12:00');

subsection('Modo InHouse - Despacho null');
log(`InHouse despachoAsignado es null: ${inhouseTemprano.despachoAsignado === null}`, inhouseTemprano.despachoAsignado === null);
log(`InHouse ejecutabilidad NO cambia: ${inhouseTemprano.ejecutabilidad === 'AHORA'}`, inhouseTemprano.ejecutabilidad === 'AHORA');
log(`InHouse estadoMercado NO cambia: ${inhouseTemprano.estadoMercado === 'ABIERTO_TEMPRANO'}`, inhouseTemprano.estadoMercado === 'ABIERTO_TEMPRANO');

// ============================================
// RESUMEN FINAL
// ============================================
section('üìä RESUMEN FINAL');
const total = passCount + failCount;
const summary = document.createElement('div');
summary.innerHTML = `
    <h2 style="color: ${failCount === 0 ? '#28a745' : '#dc3545'}">
        ${failCount === 0 ? '‚úÖ TODAS LAS PRUEBAS PASARON' : '‚ùå HAY PRUEBAS FALLIDAS'}
    </h2>
    <p>Total: ${total} pruebas</p>
    <p style="color: #28a745">‚úÖ Pasaron: ${passCount}</p>
    <p style="color: #dc3545">‚ùå Fallaron: ${failCount}</p>
`;
results.appendChild(summary);

// Confirmaci√≥n de invariantes
const invariantes = document.createElement('div');
invariantes.innerHTML = `
    <h3>Confirmaci√≥n de Invariantes</h3>
    <ul>
        <li>IG.1 (Unicidad temporal): ‚úÖ D no conoce modo</li>
        <li>IG.2 (G √∫nico stateful): ‚úÖ Solo G tiene estado</li>
        <li>IG.3 (Atemporalidad de C): ‚úÖ C sin cambios</li>
        <li>IG.4 (Validez no booleana): ‚úÖ Estructura preservada</li>
        <li>IG.5 (Determinismo): ‚úÖ Contexto congelado, resultados id√©nticos</li>
        <li>IG.6 (No coerci√≥n): ‚úÖ Puntos informativos</li>
        <li>IG.7 (Agencia humana): ‚úÖ Sin automatismos</li>
    </ul>
`;
results.appendChild(invariantes);
</script>
</body>
</html>
